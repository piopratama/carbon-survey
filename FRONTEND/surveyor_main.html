<!doctype html>
<html lang="en">
  <head>
    <script src="js/config.js"></script>
    <script>
      window.REQUIRED_ROLE = "surveyor";
    </script>
    <script>
      fetch("partials/head.html")
        .then((r) => r.text())
        .then((html) => {
          document.head.insertAdjacentHTML("beforeend", html);
        });
    </script>

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />

    <style>
      #map {
        width: 100%;
        height: 100%;
      }

      .container-fluid,
      .row {
        height: 100%;
      }
    </style>
  </head>

  <body class="d-flex flex-column min-vh-100">
    <div id="header"></div>

    <!-- ========================= -->
    <!-- MODAL -->
    <!-- ========================= -->
    <div class="modal fade" id="measurementModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Tree Measurement</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>

          <div class="modal-body">
            <input type="hidden" id="measurementPointId" />

            <!-- Survey Description -->
            <div class="alert alert-info small">
              <strong>Survey Description:</strong>
              <div id="surveyDescription"></div>
            </div>

            <div class="row">
              <div class="col-md-6 mb-2">
                <label>Tree Species</label>
                <select
                  id="speciesSelect"
                  class="form-select form-select-sm"
                ></select>
              </div>

              <!-- Species Detail -->
              <div class="col-12 mb-2">
                <div
                  id="speciesDetailBox"
                  class="border rounded p-2 small bg-light"
                  style="display: none"
                >
                  <strong id="speciesName"></strong><br />
                  <em id="speciesLatin" class="text-muted"></em>
                  <div id="speciesDescription" class="mt-1"></div>
                  <div id="speciesExtra" class="mt-1 text-muted"></div>
                </div>
              </div>

              <div class="col-md-3 mb-2">
                <label>DBH (cm)</label>
                <input
                  type="number"
                  id="dbhInput"
                  class="form-control form-control-sm"
                />
              </div>

              <div class="col-md-3 mb-2">
                <label>Height (m)</label>
                <input
                  type="number"
                  step="0.1"
                  id="heightInput"
                  class="form-control form-control-sm"
                />
              </div>

              <div class="col-12 mb-2">
                <label>Notes</label>
                <textarea
                  id="notesInput"
                  class="form-control form-control-sm"
                ></textarea>
              </div>

              <div class="col-md-4 mb-2">
                <input
                  type="file"
                  id="photo1"
                  class="form-control form-control-sm"
                />
              </div>

              <div class="col-md-4 mb-2">
                <input
                  type="file"
                  id="photo2"
                  class="form-control form-control-sm"
                />
              </div>

              <div class="col-md-4 mb-2">
                <input
                  type="file"
                  id="photo3"
                  class="form-control form-control-sm"
                />
              </div>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
              Cancel
            </button>

            <button
              class="btn btn-primary btn-sm"
              onclick="SurveyorApp.submitMeasurement()"
            >
              Submit
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ========================= -->
    <!-- MAIN -->
    <!-- ========================= -->

    <div class="container-fluid flex-grow-1 p-0">
      <!-- MOBILE PROJECT SELECT -->
      <div class="d-md-none p-3 bg-light border-bottom">
        <h6 class="mb-2">Project</h6>
        <select
          id="projectSelect"
          class="form-select form-select-sm"
          onchange="SurveyorApp.selectProject()"
        >
          <option value="">-- Select Project --</option>
        </select>
      </div>

      <div class="row g-0 h-100">
        <!-- MAP -->
        <div class="col-12 col-md-9">
          <div id="map"></div>
        </div>

        <!-- DESKTOP SIDEBAR -->
        <div class="d-none d-md-block col-md-3 bg-light border-start">
          <div class="p-3">
            <div class="card shadow-sm">
              <div class="card-body">
                <h6 class="mb-2">Project</h6>
                <select
                  id="projectSelectDesktop"
                  class="form-select form-select-sm"
                  onchange="SurveyorApp.selectProject()"
                >
                  <option value="">-- Select Project --</option>
                </select>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    <div id="footer"></div>

    <script>
      async function loadPartial(id, file) {
        const res = await fetch(file);
        const html = await res.text();
        document.getElementById(id).innerHTML = html;

        if (id === "header") {
          initHeaderLogic();
        }
      }

      function initHeaderLogic() {
        const userData = localStorage.getItem("user");
        if (!userData) return;

        const currentUser = JSON.parse(userData);

        const userInfo = document.getElementById("userInfo");
        if (userInfo) {
          userInfo.innerText = currentUser.name + " (" + currentUser.role + ")";
        }

        if (currentUser.role !== "admin") {
          document.querySelectorAll(".admin-only").forEach((el) => el.remove());
        }

        if (currentUser.role !== "surveyor") {
          document
            .querySelectorAll(".surveyor-only")
            .forEach((el) => el.remove());
        }

        const current = window.location.pathname.split("/").pop();

        document.querySelectorAll(".nav-link").forEach((link) => {
          if (link.getAttribute("href") === current) {
            link.classList.add("active");
          }
        });
      }

      window.logout = function () {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        window.location.href = "index.html";
      };

      loadPartial("header", "partials/header.html");
      loadPartial("footer", "partials/footer.html");
    </script>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/core/sampling-core.js"></script>
    <script src="js/core/project-core.js"></script>
    <script src="js/surveyor/surveyor-popup.js"></script>
    <script src="js/surveyor/surveyor-main.js"></script>
  </body>
</html>
