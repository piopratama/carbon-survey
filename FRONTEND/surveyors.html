<script>
  window.REQUIRED_ROLE = "admin";
</script>

<!doctype html>
<html lang="en">
  <head>
    <script>
      fetch("partials/head.html")
        .then((r) => r.text())
        .then((html) => document.head.insertAdjacentHTML("beforeend", html));
    </script>
  </head>

  <body class="d-flex flex-column min-vh-100">
    <div id="header"></div>

    <div class="container py-4 flex-grow-1">
      <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0">Users</h4>
        <button class="btn btn-primary btn-sm" onclick="openForm()">
          Add User
        </button>
      </div>

      <!-- FORM -->
      <div id="formCard" class="card mb-4 d-none">
        <div class="card-body">
          <h6 id="formTitle" class="mb-3">New User</h6>

          <input type="hidden" id="userIdInput" />

          <div class="mb-2">
            <label class="form-label small">Name</label>
            <input id="nameInput" class="form-control form-control-sm" />
          </div>

          <div class="mb-2">
            <label class="form-label small">Email</label>
            <input
              id="emailInput"
              type="email"
              class="form-control form-control-sm"
            />
          </div>

          <div class="mb-2">
            <label class="form-label small">Password</label>
            <input
              id="passwordInput"
              type="password"
              class="form-control form-control-sm"
            />
            <small class="text-muted">Kosongkan jika tidak diubah</small>
          </div>

          <div class="mb-3">
            <label class="form-label small">Role</label>
            <select id="roleInput" class="form-select form-select-sm">
              <option value="admin">Admin</option>
              <option value="surveyor">Surveyor</option>
            </select>
          </div>

          <div class="d-flex gap-2">
            <button class="btn btn-success btn-sm" onclick="saveUser()">
              Save
            </button>
            <button class="btn btn-secondary btn-sm" onclick="closeForm()">
              Cancel
            </button>
          </div>
        </div>
      </div>

      <!-- TABLE -->
      <div class="card shadow-sm">
        <div class="card-body p-0">
          <table class="table table-sm mb-0">
            <thead class="table-light">
              <tr>
                <th>Name</th>
                <th>Email</th>
                <th>Role</th>
                <th width="120">Actions</th>
              </tr>
            </thead>
            <tbody id="usersTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div id="footer"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      async function loadPartial(id, file) {
        const res = await fetch(file);
        const html = await res.text();
        document.getElementById(id).innerHTML = html;

        if (id === "header") {
          initHeaderLogic();
        }
      }

      function initHeaderLogic() {
        const userData = localStorage.getItem("user");
        if (!userData) return;

        const currentUser = JSON.parse(userData);

        // tampilkan user info
        const userInfo = document.getElementById("userInfo");
        if (userInfo) {
          userInfo.innerText = currentUser.name + " (" + currentUser.role + ")";
        }

        // hide admin menu
        if (currentUser.role !== "admin") {
          document.querySelectorAll(".admin-only").forEach((el) => el.remove());
        }

        // hide surveyor menu
        if (currentUser.role !== "surveyor") {
          document
            .querySelectorAll(".surveyor-only")
            .forEach((el) => el.remove());
        }

        // highlight active link
        const current = window.location.pathname.split("/").pop();
        document.querySelectorAll(".nav-link").forEach((link) => {
          if (link.getAttribute("href") === current) {
            link.classList.add("active");
          }
        });
      }

      window.logout = function () {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        window.location.href = "index.html";
      };

      loadPartial("header", "partials/header.html");
      loadPartial("footer", "partials/footer.html");
    </script>

    <script>
      async function loadPartial(id, file) {
        const res = await fetch(file);
        const html = await res.text();
        document.getElementById(id).innerHTML = html;

        if (id === "header") {
          initHeaderLogic();
        }
      }

      function initHeaderLogic() {
        const userData = localStorage.getItem("user");
        if (!userData) return;

        const currentUser = JSON.parse(userData);

        // tampilkan user info
        const userInfo = document.getElementById("userInfo");
        if (userInfo) {
          userInfo.innerText = currentUser.name + " (" + currentUser.role + ")";
        }

        // hide admin menu
        if (currentUser.role !== "admin") {
          document.querySelectorAll(".admin-only").forEach((el) => el.remove());
        }

        // hide surveyor menu
        if (currentUser.role !== "surveyor") {
          document
            .querySelectorAll(".surveyor-only")
            .forEach((el) => el.remove());
        }

        // highlight active link
        const current = window.location.pathname.split("/").pop();
        document.querySelectorAll(".nav-link").forEach((link) => {
          if (link.getAttribute("href") === current) {
            link.classList.add("active");
          }
        });
      }

      loadPartial("header", "partials/header.html");
      loadPartial("footer", "partials/footer.html");
    </script>

    <script>
      const API_BASE = "http://127.0.0.1:8000";

      async function loadUsers() {
        const res = await fetch(`${API_BASE}/users`);
        const data = await res.json();

        const tbody = document.getElementById("usersTable");
        tbody.innerHTML = "";

        data.forEach((u) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${u.name}</td>
            <td>${u.email}</td>
            <td>${u.role}</td>
            <td>
              <button class="btn btn-sm btn-warning" onclick='editUser(${JSON.stringify(u)})'>Edit</button>
              <button class="btn btn-sm btn-danger" onclick="deleteUser('${u.id}')">Delete</button>
            </td>
          `;
          tbody.appendChild(tr);
        });
      }

      function openForm() {
        document.getElementById("formTitle").innerText = "New User";
        document.getElementById("formCard").classList.remove("d-none");
        document.getElementById("userIdInput").value = "";
      }

      function closeForm() {
        document.getElementById("formCard").classList.add("d-none");
        document.getElementById("nameInput").value = "";
        document.getElementById("emailInput").value = "";
        document.getElementById("passwordInput").value = "";
        document.getElementById("roleInput").value = "surveyor";
      }

      function editUser(u) {
        openForm();
        document.getElementById("formTitle").innerText = "Edit User";
        document.getElementById("userIdInput").value = u.id;
        document.getElementById("nameInput").value = u.name;
        document.getElementById("emailInput").value = u.email;
        document.getElementById("roleInput").value = u.role;
      }

      async function saveUser() {
        const id = document.getElementById("userIdInput").value;
        const payload = {
          name: nameInput.value,
          email: emailInput.value,
          password: passwordInput.value,
          role: roleInput.value,
        };

        const url = id ? `${API_BASE}/users/${id}` : `${API_BASE}/users`;
        const method = id ? "PUT" : "POST";

        const res = await fetch(url, {
          method,
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload),
        });

        if (!res.ok) {
          const err = await res.json();
          alert(err.detail || "Failed");
          return;
        }

        closeForm();
        loadUsers();
      }

      async function deleteUser(id) {
        if (!confirm("Delete this user?")) return;

        await fetch(`${API_BASE}/users/${id}`, { method: "DELETE" });
        loadUsers();
      }

      loadUsers();
    </script>
  </body>
</html>
