<!doctype html>
<html lang="en">
  <head>
    <script src="js/config.js"></script>
    <script>
      window.REQUIRED_ROLE = "admin";
    </script>
    <script>
      fetch("partials/head.html")
        .then((r) => r.text())
        .then((html) => {
          document.head.insertAdjacentHTML("beforeend", html);
        });
    </script>
    <!-- Leaflet (ONLY FOR MAP PAGE) -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css"
    />
  </head>

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
    }

    #map {
      width: 100%;
      height: calc(100vh - 120px);
    }
  </style>

  <body class="d-flex flex-column min-vh-100">
    <!-- ================= HEADER ================= -->
    <div id="header"></div>

    <div class="modal fade" id="assignSurveyModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Assign Surveyor</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>

          <div class="modal-body">
            <input type="hidden" id="assignPointId" />

            <!-- Dropdown surveyor -->
            <div class="mb-2">
              <label>Pilih Surveyor</label>
              <select
                id="availableSurveyors"
                class="form-select form-select-sm"
              ></select>
            </div>

            <button
              class="btn btn-primary btn-sm mb-3"
              onclick="AdminApp.assignSurveyor()"
            >
              Tambah
            </button>

            <hr />

            <h6>Surveyor Terdaftar</h6>

            <!-- INI WAJIB ADA -->
            <div id="assignedSurveyors"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ================= SURVEY SETUP MODAL ================= -->
    <div class="modal fade" id="surveySetupModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Setup Survey</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>

          <div class="modal-body">
            <input type="hidden" id="setupPointId" />

            <div class="mb-2">
              <label>Start Date</label>
              <input
                type="date"
                id="setupStartDate"
                class="form-control form-control-sm"
              />
            </div>

            <div class="mb-2">
              <label>End Date</label>
              <input
                type="date"
                id="setupEndDate"
                class="form-control form-control-sm"
              />
            </div>

            <div class="mb-2">
              <label>Description</label>
              <textarea
                id="setupDescription"
                class="form-control form-control-sm"
              ></textarea>
            </div>

            <div class="mb-2">
              <label>Max Surveyor</label>
              <input
                type="number"
                id="setupMaxSurveyor"
                class="form-control form-control-sm"
                value="5"
                min="1"
                max="10"
              />
            </div>

            <div class="mb-2">
              <label>Plot Radius (meter)</label>
              <input
                type="number"
                id="setupPlotRadius"
                class="form-control form-control-sm"
                value="10"
                min="1"
                max="50"
              />
              <small class="text-muted">
                Radius of circular plot (example: 10m)
              </small>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
              Cancel
            </button>
            <button
              class="btn btn-primary btn-sm"
              onclick="AdminApp.saveSurveySetup()"
            >
              Save Setup
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- ================= MAIN ================= -->
    <div class="container-fluid flex-grow-1 p-0">
      <!-- MOBILE TOGGLE BUTTON -->
      <div class="d-md-none bg-light border-bottom p-2">
        <button
          class="btn btn-primary btn-sm w-100"
          data-bs-toggle="collapse"
          data-bs-target="#mobileControlPanel"
        >
          Show Controls
        </button>
      </div>

      <div class="row g-0 h-100">
        <!-- ================= MAP ================= -->
        <div class="col-12 col-md-8 col-lg-9 order-2 order-md-1">
          <div id="map"></div>
        </div>

        <!-- ================= CONTROL PANEL ================= -->
        <div
          id="mobileControlPanel"
          class="collapse d-md-block col-12 col-md-4 col-lg-3 bg-light border-start order-1 order-md-2 overflow-auto"
        >
          <div class="p-3">
            <div class="card shadow-sm">
              <div class="card-body">
                <!-- ================= LOKASI ================= -->
                <h6 class="mb-2">Location</h6>

                <div class="input-group mb-3">
                  <input
                    id="searchInput"
                    class="form-control"
                    placeholder="Example: Ubud"
                  />
                  <button
                    class="btn btn-primary"
                    onclick="AdminApp.searchLocation()"
                  >
                    Search
                  </button>
                </div>

                <hr />

                <!-- ================= PROJECT ================= -->
                <h6 class="mb-2">Project</h6>

                <select
                  id="projectSelect"
                  class="form-select form-select-sm mb-2"
                  onchange="AdminApp.selectProject()"
                >
                  <option value="">-- Select Project --</option>
                </select>

                <div class="d-grid gap-2 mb-3">
                  <button
                    id="newProjectBtn"
                    class="btn btn-outline-success btn-sm"
                    onclick="startNewProject()"
                  >
                    New Project
                  </button>
                </div>

                <div class="mb-3">
                  <label class="form-label small">Project Name (new)</label>
                  <input
                    id="projectNameInput"
                    class="form-control form-control-sm"
                    placeholder="Contoh: Labuan Bajo Carbon Study"
                  />
                </div>

                <hr />

                <!-- ================= AREA FOKUS ================= -->
                <h6 class="mb-2">Focus Area</h6>

                <div
                  id="aoiControlSection"
                  class="d-grid gap-2 mb-3"
                  style="display: none"
                >
                  <button
                    id="editBtn"
                    class="btn btn-outline-primary btn-sm"
                    onclick="enableEditAOI()"
                    disabled
                  >
                    Edit Focus Area
                  </button>

                  <button
                    id="resetBtn"
                    class="btn btn-outline-secondary btn-sm"
                    onclick="resetAOI()"
                    disabled
                  >
                    Reset Focus Area
                  </button>
                </div>

                <div class="d-grid gap-2 mb-2">
                  <button
                    id="saveProjectBtn"
                    class="btn btn-success btn-sm"
                    onclick="saveProject()"
                    disabled
                  >
                    Save Project
                  </button>

                  <button
                    class="btn btn-danger btn-sm"
                    onclick="deleteProject()"
                  >
                    Delete Project
                  </button>
                </div>

                <div id="status" class="text-muted small mb-3"></div>

                <hr />

                <!-- ================= SAMPLING ================= -->
                <h6 class="mb-2">Sampling</h6>

                <div id="samplingSection" style="display: none">
                  <label class="form-label small">Mode Sampling</label>

                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="samplingMode"
                      value="grid"
                      checked
                      onchange="AdminApp.onSamplingModeChange()"
                    />
                    <label class="form-check-label small"> Grid </label>
                  </div>

                  <div class="form-check mb-2">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="samplingMode"
                      value="manual"
                      onchange="AdminApp.onSamplingModeChange()"
                    />
                    <label class="form-check-label small">
                      Manual (click map)
                    </label>
                  </div>

                  <div class="mb-2">
                    <label class="form-label small">
                      Point Distance (meter)
                    </label>
                    <input
                      id="spacingInput"
                      type="number"
                      class="form-control form-control-sm"
                      value="50"
                      min="10"
                      step="10"
                    />
                  </div>

                  <div class="d-grid gap-2 mb-2">
                    <button
                      class="btn btn-outline-primary btn-sm"
                      onclick="AdminApp.previewSampling()"
                    >
                      Preview Number of Points
                    </button>

                    <button
                      class="btn btn-success btn-sm"
                      onclick="AdminApp.generateSampling()"
                    >
                      Generate Sampling
                    </button>
                  </div>

                  <div id="samplingPreview" class="text-muted small mb-2">
                    No Calculation
                  </div>

                  <div class="d-grid gap-2 mb-2">
                    <button
                      class="btn btn-outline-danger btn-sm"
                      onclick="AdminApp.removeAllSampling()"
                    >
                      Remove All Sampling Points
                    </button>
                  </div>
                </div>

                <hr />

                <!-- ================= SENTINEL ================= -->
                <div id="sentinelSection" style="display: none">
                  <h6 class="mb-2">Sentinel Preview</h6>

                  <div class="mb-2">
                    <label class="form-label small">Year</label>
                    <input
                      id="yearInput"
                      type="number"
                      class="form-control form-control-sm"
                      value="2024"
                    />
                  </div>

                  <div class="mb-2">
                    <label class="form-label small">
                      Month (comma separated)
                    </label>
                    <input
                      id="monthsInput"
                      class="form-control form-control-sm"
                      value="6,7,8"
                    />
                  </div>

                  <div class="mb-2">
                    <label class="form-label small">Cloud (%)</label>
                    <input
                      id="cloudInput"
                      type="number"
                      class="form-control form-control-sm"
                      value="20"
                    />
                  </div>

                  <button
                    class="btn btn-primary btn-sm w-100"
                    onclick="loadSentinelPreview()"
                  >
                    Show Sentinel
                  </button>
                </div>

                <hr />

                <!-- ================= RESET ================= -->
                <button
                  class="btn btn-outline-danger btn-sm w-100"
                  onclick="resetAll()"
                >
                  Reset All
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ================= FOOTER ================= -->
    <div id="footer"></div>

    <!-- ================= SCRIPTS ================= -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script src="js/project_state.js"></script>
    <script src="js/layout.js"></script>
    <script src="js/map.js"></script>
    <script src="js/project.js"></script>
    <script src="js/core/sampling-core.js"></script>
    <script src="js/core/project-core.js"></script>
    <script src="js/admin/admin-sampling.js"></script>
    <script src="js/admin/admin-sampling-ui.js"></script>
    <script src="js/sentinel.js"></script>
    <script src="js/survey-setup.js"></script>
    <script src="js/assign.js"></script>
    <script src="js/ui.js"></script>
    <script src="js/main.js"></script>
  </body>
</html>
