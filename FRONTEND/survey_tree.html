<script>
  window.REQUIRED_ROLE = ["surveyor", "admin"];
</script>

<!doctype html>
<html lang="en">
  <head>
    <script>
      fetch("partials/head.html")
        .then((r) => r.text())
        .then((html) => {
          document.head.insertAdjacentHTML("beforeend", html);
        });
    </script>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>

  <body class="d-flex flex-column min-vh-100">
    <div id="header"></div>

    <div class="modal fade" id="imageModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark">
          <div class="modal-body text-center p-0">
            <img id="modalImage" class="img-fluid" />
          </div>
        </div>
      </div>
    </div>

    <div class="container py-4">
      <!-- SAMPLING POINT DETAIL -->
      <div class="card mb-4 shadow-sm">
        <div class="card-body">
          <h5>Sampling Point ID: <span id="pointIdLabel"></span></h5>

          <table class="table table-sm table-borderless mb-0">
            <tr>
              <td width="160"><strong>Status</strong></td>
              <td id="pointStatus"></td>
            </tr>
            <tr>
              <td><strong>Latitude</strong></td>
              <td id="pointLat"></td>
            </tr>
            <tr>
              <td><strong>Longitude</strong></td>
              <td id="pointLng"></td>
            </tr>
            <tr>
              <td><strong>Period</strong></td>
              <td id="pointPeriod"></td>
            </tr>
            <tr>
              <td><strong>Surveyors in This Point</strong></td>
              <td id="assignedSurveyors"></td>
            </tr>
            <tr>
              <td><strong>Description</strong></td>
              <td id="pointDescription"></td>
            </tr>
            <tr>
              <td><strong>Capacity</strong></td>
              <td id="pointCapacity"></td>
            </tr>
            <tr>
              <td><strong>Total Biomass</strong></td>
              <td id="pointTotalBiomass">0 kg</td>
            </tr>
          </table>
        </div>
      </div>

      <!-- TREE TABLE -->
      <div class="d-flex justify-content-between align-items-center mb-2">
        <h6 class="mb-0">Trees in This Sampling Point</h6>
        <button class="btn btn-primary btn-sm" onclick="openTreeForm()">
          + Add Tree
        </button>
      </div>

      <div class="card shadow-sm">
        <div class="card-body p-0">
          <table class="table table-sm mb-0">
            <thead class="table-light">
              <tr>
                <th>ID</th>
                <th>Species</th>
                <th>DBH</th>
                <th>Height</th>
                <th>Biomass</th>
                <th>Latitude</th>
                <th>Longitude</th>
                <th>Input By</th>
                <th>Input At</th>
                <th>Photos</th>
                <!-- TAMBAH INI -->
                <th width="140"></th>
              </tr>
            </thead>

            <tbody id="treeTable"></tbody>
          </table>
        </div>
      </div>

      <div class="mt-4 text-end">
        <button class="btn btn-success" onclick="submitSamplingPoint()">
          Submit Sampling Point
        </button>
      </div>
    </div>

    <!-- ============================= -->
    <!-- IMAGE PREVIEW MODAL -->
    <!-- ============================= -->
    <div class="modal fade" id="imageModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content bg-dark">
          <div class="modal-body text-center p-0">
            <img id="modalImage" class="img-fluid" />
          </div>
        </div>
      </div>
    </div>

    <!-- ============================= -->
    <!-- TREE MODAL -->
    <!-- ============================= -->
    <div class="modal fade" id="treeModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Tree Measurement</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>

          <div class="modal-body">
            <input type="hidden" id="surveyId" />

            <!-- Species Dropdown -->
            <div class="mb-2">
              <label>Tree Species</label>
              <select id="speciesSelect" class="form-select form-select-sm">
                <option value="">-- Select Species --</option>
              </select>
            </div>

            <!-- Species Detail Box -->
            <div
              id="speciesDetailBox"
              class="border rounded p-2 small bg-light mb-3"
              style="display: none"
            >
              <strong id="speciesName"></strong><br />
              <em id="speciesScientific" class="text-muted"></em>
              <div id="speciesDescription" class="mt-1"></div>
              <div class="mt-2">
                <div>
                  <strong>Wood Density:</strong>
                  <span id="speciesDensity"></span>
                </div>
                <div>
                  <strong>Biomass Formula:</strong>
                  <span id="speciesFormula"></span>
                </div>
              </div>
            </div>

            <!-- Measurement Inputs -->
            <div class="row">
              <div class="col-md-4 mb-2">
                <label>DBH (cm)</label>
                <input
                  type="number"
                  id="dbhInput"
                  class="form-control form-control-sm"
                />
              </div>

              <div class="col-md-4 mb-2">
                <label>Height (m)</label>
                <input
                  type="number"
                  step="0.1"
                  id="heightInput"
                  class="form-control form-control-sm"
                />
              </div>

              <div class="col-md-4 mb-2">
                <label>Latitude</label>
                <input
                  type="number"
                  step="0.000001"
                  id="latInput"
                  class="form-control form-control-sm"
                />
              </div>

              <div class="col-md-4 mb-3">
                <label>Longitude</label>
                <input
                  type="number"
                  step="0.000001"
                  id="lngInput"
                  class="form-control form-control-sm"
                />
              </div>
            </div>

            <hr />

            <!-- ============================= -->
            <!-- SURVEY PHOTOS (3 SLOT) -->
            <!-- ============================= -->

            <h6>Survey Photos</h6>

            <div class="mb-3">
              <label>Photo 1</label>
              <input
                type="file"
                id="photo1"
                class="form-control form-control-sm"
                accept="image/*"
                capture="environment"
              />
              <div id="preview1" class="mt-2"></div>
            </div>

            <div class="mb-3">
              <label>Photo 2</label>
              <input
                type="file"
                id="photo2"
                class="form-control form-control-sm"
                accept="image/*"
                capture="environment"
              />
              <div id="preview2" class="mt-2"></div>
            </div>

            <div class="mb-3">
              <label>Photo 3</label>
              <input
                type="file"
                id="photo3"
                class="form-control form-control-sm"
                accept="image/*"
                capture="environment"
              />
              <div id="preview3" class="mt-2"></div>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
              Cancel
            </button>

            <button class="btn btn-primary btn-sm" onclick="saveTree()">
              Save
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="footer"></div>

    <script>
      async function loadPartial(id, file) {
        const res = await fetch(file);
        const html = await res.text();
        document.getElementById(id).innerHTML = html;

        if (id === "header") {
          initHeaderLogic();
        }
      }

      function initHeaderLogic() {
        const userData = localStorage.getItem("user");
        if (!userData) return;

        const currentUser = JSON.parse(userData);

        const userInfo = document.getElementById("userInfo");
        if (userInfo) {
          userInfo.innerText = currentUser.name + " (" + currentUser.role + ")";
        }

        if (currentUser.role !== "admin") {
          document.querySelectorAll(".admin-only").forEach((el) => el.remove());
        }

        if (currentUser.role !== "surveyor") {
          document
            .querySelectorAll(".surveyor-only")
            .forEach((el) => el.remove());
        }

        const current = window.location.pathname.split("/").pop();

        document.querySelectorAll(".nav-link").forEach((link) => {
          if (link.getAttribute("href") === current) {
            link.classList.add("active");
          }
        });
      }

      window.logout = function () {
        localStorage.removeItem("token");
        localStorage.removeItem("user");
        window.location.href = "index.html";
      };

      loadPartial("header", "partials/header.html");
      loadPartial("footer", "partials/footer.html");
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const API_BASE = "http://127.0.0.1:8000";
        const currentUser = JSON.parse(localStorage.getItem("user") || "{}");
        const POINT_ID = new URLSearchParams(window.location.search).get(
          "point_id",
        );

        if (!POINT_ID) {
          alert("No point_id provided");
          return;
        }

        let editingId = null;
        let SPECIES_DATA = [];
        let POINT_DATA = null;
        let SURVEY_DATA = [];

        const modal = new bootstrap.Modal(document.getElementById("treeModal"));

        document.getElementById("pointIdLabel").innerText = POINT_ID;

        /* ========================= */
        /* LOAD POINT               */
        /* ========================= */

        async function loadPoint() {
          try {
            const res = await fetch(`${API_BASE}/sampling/point/${POINT_ID}`);
            if (!res.ok) return;

            POINT_DATA = await res.json();

            document.getElementById("pointStatus").innerText =
              POINT_DATA.survey_status || "-";
            document.getElementById("pointLat").innerText = Number(
              POINT_DATA.latitude || 0,
            ).toFixed(6);
            document.getElementById("pointLng").innerText = Number(
              POINT_DATA.longitude || 0,
            ).toFixed(6);
            document.getElementById("pointPeriod").innerText =
              `${POINT_DATA.start_date || "-"} s/d ${POINT_DATA.end_date || "-"}`;
            document.getElementById("pointDescription").innerText =
              POINT_DATA.description || "-";
            document.getElementById("pointCapacity").innerText =
              `${POINT_DATA.assigned_count || 0}/${POINT_DATA.max_surveyors || 0}`;

            document.getElementById("pointTotalBiomass").innerText =
              Number(POINT_DATA.total_biomass || 0).toFixed(2) + " kg";
          } catch (err) {
            console.error("Load point error:", err);
          }
        }

        /* ========================= */
        /* LOAD SPECIES             */
        /* ========================= */

        async function loadSpecies() {
          try {
            const res = await fetch(`${API_BASE}/tree-species`);
            if (!res.ok) return;

            SPECIES_DATA = await res.json();

            const select = document.getElementById("speciesSelect");
            select.innerHTML = `<option value="">-- Select Species --</option>`;

            SPECIES_DATA.forEach((s) => {
              select.innerHTML += `<option value="${s.id}">${s.local_name}</option>`;
            });
          } catch (err) {
            console.error("Load species error:", err);
          }
        }

        document
          .getElementById("speciesSelect")
          .addEventListener("change", function () {
            const id = this.value;
            const s = SPECIES_DATA.find((x) => x.id == id);

            if (!s) {
              document.getElementById("speciesDetailBox").style.display =
                "none";
              return;
            }

            document.getElementById("speciesDetailBox").style.display = "block";
            document.getElementById("speciesName").innerText = s.local_name;
            document.getElementById("speciesScientific").innerText =
              s.scientific_name;
            document.getElementById("speciesDescription").innerText =
              s.description || "-";
            document.getElementById("speciesDensity").innerText =
              s.wood_density || "-";
            document.getElementById("speciesFormula").innerText =
              s.biomass_formula || "-";
          });

        /* ========================= */
        /* LOAD TREES               */
        /* ========================= */

        async function loadTrees() {
          try {
            const res = await fetch(`${API_BASE}/survey/by-point/${POINT_ID}`);
            if (!res.ok) return;

            const data = await res.json();
            SURVEY_DATA = Array.isArray(data) ? data : [];

            const tbody = document.getElementById("treeTable");
            tbody.innerHTML = "";

            if (!SURVEY_DATA.length) {
              tbody.innerHTML = `
          <tr>
            <td colspan="10" class="text-center text-muted">
              No tree measurements yet
            </td>
          </tr>`;
              return;
            }

            SURVEY_DATA.forEach((t) => {
              const inputDate = t.created_at
                ? new Date(t.created_at).toLocaleString()
                : "-";

              const tr = document.createElement("tr");

              tr.innerHTML = `
                <td>${t.survey_id}</td>
                <td>${t.tree_species?.local_name || "-"}</td>
                <td>${t.dbh_cm || "-"}</td>
                <td>${t.height_m || "-"}</td>
                <td>${t.biomass || "-"}</td>
                <td>${t.latitude ? Number(t.latitude).toFixed(6) : "-"}</td>
                <td>${t.longitude ? Number(t.longitude).toFixed(6) : "-"}</td>
                <td>${t.input_by_name || "-"}</td>
                <td>${inputDate}</td>
                <td>
                    ${thumb(t.photo1)}
                    ${thumb(t.photo2)}
                    ${thumb(t.photo3)}
                </td>
                <td>
                    <button class="btn btn-sm btn-warning me-1"
                    onclick="editTree(${t.survey_id})">Edit</button>
                    <button class="btn btn-sm btn-danger"
                    onclick="deleteTree(${t.survey_id})">Delete</button>
                </td>
                `;

              tbody.appendChild(tr);
            });
          } catch (err) {
            console.error("Load trees error:", err);
          }
        }

        /* ========================= */
        /* OPEN FORM                */
        /* ========================= */

        window.openTreeForm = function () {
          editingId = null;

          speciesSelect.value = "";
          dbhInput.value = "";
          heightInput.value = "";

          if (POINT_DATA) {
            latInput.value = POINT_DATA.latitude;
            lngInput.value = POINT_DATA.longitude;
          }

          document.getElementById("speciesDetailBox").style.display = "none";
          modal.show();
        };

        /* ========================= */
        /* SAVE                     */
        /* ========================= */

        window.saveTree = async function () {
          const speciesId = speciesSelect.value;
          const dbh = dbhInput.value;
          const height = heightInput.value;
          const lat = latInput.value;
          const lng = lngInput.value;

          if (!speciesId) return alert("Please select tree species");
          if (!dbh) return alert("DBH required");
          if (!lat || !lng) return alert("Latitude & Longitude required");

          const payload = {
            surveyor_id: currentUser.id,
            tree_species_id: Number(speciesId),
            dbh_cm: Number(dbh),
            height_m: height ? Number(height) : null,
            latitude: Number(lat),
            longitude: Number(lng),
          };

          const url = editingId
            ? `${API_BASE}/survey/${editingId}`
            : `${API_BASE}/survey/tree/${POINT_ID}`;

          const method = editingId ? "PUT" : "POST";

          const res = await fetch(url, {
            method,
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          });

          const result = await res.json();

          if (!res.ok) {
            alert(result.detail || "Failed to save");
            return;
          }

          const surveyId = editingId || result.survey_id;

          /* ========================= */
          /* UPLOAD PHOTOS             */
          /* ========================= */

          const photo1Url = await uploadFile("photo1");
          const photo2Url = await uploadFile("photo2");
          const photo3Url = await uploadFile("photo3");

          if (photo1Url || photo2Url || photo3Url) {
            await fetch(`${API_BASE}/survey/${surveyId}/photos-single`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                photo1: photo1Url,
                photo2: photo2Url,
                photo3: photo3Url,
              }),
            });
          }

          modal.hide();
          loadTrees();
        };

        /* ========================= */
        /* DELETE                   */
        /* ========================= */

        window.deleteTree = async function (id) {
          if (!confirm("Delete tree measurement?")) return;

          try {
            await fetch(`${API_BASE}/survey/${id}`, { method: "DELETE" });
            loadTrees();
          } catch (err) {
            console.error("Delete error:", err);
          }
        };

        /* ========================= */
        /* EDIT                     */
        /* ========================= */

        window.editTree = function (id) {
          const survey = SURVEY_DATA.find((s) => s.survey_id == id);
          if (!survey) return;

          editingId = id;

          speciesSelect.value = survey.tree_species_id;
          speciesSelect.dispatchEvent(new Event("change"));

          dbhInput.value = survey.dbh_cm;
          heightInput.value = survey.height_m || "";
          latInput.value = survey.latitude;
          lngInput.value = survey.longitude;

          // SHOW EXISTING PHOTOS
          showExistingPreview("preview1", survey.photo1);
          showExistingPreview("preview2", survey.photo2);
          showExistingPreview("preview3", survey.photo3);

          modal.show();
        };

        function bindImagePreview(inputId, previewId) {
          const input = document.getElementById(inputId);
          const preview = document.getElementById(previewId);

          input.addEventListener("change", function () {
            preview.innerHTML = "";

            if (!this.files || !this.files[0]) return;

            const reader = new FileReader();

            reader.onload = function (e) {
              preview.innerHTML = `
        <img src="${e.target.result}"
          style="width:100px;height:100px;object-fit:cover;border-radius:8px">
      `;
            };

            reader.readAsDataURL(this.files[0]);
          });
        }

        /* Bind 3 inputs */
        bindImagePreview("photo1", "preview1");
        bindImagePreview("photo2", "preview2");
        bindImagePreview("photo3", "preview3");

        function thumb(url) {
          if (!url) return "";
          return `
            <img src="${url}" 
            style="width:40px;height:40px;object-fit:cover;border-radius:6px;cursor:pointer"
            onclick="showImage('${url}')">
        `;
        }

        async function uploadFile(inputId) {
          const input = document.getElementById(inputId);
          if (!input.files.length) return null;

          const formData = new FormData();
          formData.append("file", input.files[0]);

          const res = await fetch(`${API_BASE}/upload?category=surveys`, {
            method: "POST",
            body: formData,
          });

          const data = await res.json();
          return data.url;
        }

        function showExistingPreview(containerId, url) {
          const container = document.getElementById(containerId);
          container.innerHTML = "";

          if (!url) return;

          container.innerHTML = `
    <img src="${url}"
      style="width:100px;height:100px;object-fit:cover;border-radius:8px;cursor:pointer"
      onclick="showImage('${url}')">
  `;
        }

        window.showImage = function (url) {
          const img = document.getElementById("modalImage");
          img.src = url;

          const imageModal = new bootstrap.Modal(
            document.getElementById("imageModal"),
          );

          imageModal.show();
        };

        async function loadAssignedSurveyors() {
          const res = await fetch(`${API_BASE}/sampling/assigned/${POINT_ID}`);
          const data = await res.json();

          const el = document.getElementById("assignedSurveyors");

          if (!data.length) {
            el.innerHTML = "<span class='text-muted'>No surveyors</span>";
            return;
          }

          el.innerHTML = data.map((s) => s.name).join(", ");
        }

        /* ========================= */
        /* INIT                     */
        /* ========================= */

        loadPoint();
        loadSpecies();
        loadTrees();
        loadAssignedSurveyors();
      });
    </script>
  </body>
</html>
